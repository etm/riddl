<?xml version="1.0"?>

<domain-description  xmlns="http://rescue.org/ns/domain/0.2"
            xmlns:rng="http://relaxng.org/ns/structure/1.0"
            xmlns:flow="http://rescue.org/ns/controlflow/0.2">
  <properties>
<!-- {{{ -->
    <rng:element name="city">
      <caption lang="en">City</caption>
      <caption lang="de">Stadt</caption>
      <rng:data type="string"/>
    </rng:element>
    <rng:element name="street">
      <caption lang="en">Street</caption>
      <caption lang="de">Stra√üe</caption>
      <rng:data type="string"/>
    </rng:element>
    <rng:element name="carpark">
      <caption lang="en">Carpark</caption>
      <caption lang="de">Parkplatz</caption>
      <rng:data type="boolean"/>
    </rng:element>
<!-- }}} -->
  </properties>
  <messages>
    <message name="search-parameters">
<!-- {{{ -->      
      <rng:element name="title">
        <caption lang="en">Title</caption>
        <caption lang="de">Titel</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="date">
        <caption lang="en">Date</caption>
        <caption lang="de">Datum</caption>
        <rng:data type="date"/>
      </rng:element>
      <rng:element name="preferred_time">
        <caption lang="en">preferred time</caption>
        <caption lang="de">bevorzugte Zeit</caption>
        <rng:data type="time"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="list-shows">
<!-- {{{ -->     
      <rng:element name="list_of_shows">
        <rng:zeroOrMore>
          <rng:element name="show">
            <rng:element name="resource-path">
              <caption lang="en">Rescource path</caption>
              <caption lang="de">Resourcepfad</caption>
              <rng:data type="string"/>
            </rng:element>
            <rng:element name="movie-title">
              <caption lang="en">Movietitle</caption>
              <caption lang="de">Filmtitel</caption>
              <rng:data type="string"/>
            </rng:element>
            <rng:element name="show-id">
              <caption lang="en">ShowID</caption>
              <caption lang="de">VorstellungsID</caption>
              <rng:data type="string"/>
            </rng:element>
            <rng:element name="starting-time">
              <caption lang="en">Starting time</caption>
              <caption lang="de">Beginzeit</caption>
              <rng:data type="time"/>
            </rng:element>
            <rng:element name="hall">
              <caption lang="en">Hall</caption>
              <caption lang="de">Saal</caption>
              <rng:data type="positiveInteger"/>
            </rng:element>
          </rng:element>
        </rng:zeroOrMore>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="selected-show">
<!-- {{{ -->    
      <rng:element name="movie_title">
        <caption lang="en">Movietitle</caption>
        <caption lang="de">Filmtitel</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="show_id">
        <caption lang="en">ShowID</caption>
        <caption lang="de">VorstellungsID</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="starting_time">
        <caption lang="en">Starting time</caption>
        <caption lang="de">Beginzeit</caption>
        <rng:data type="time"/>
      </rng:element>
      <rng:element name="hall">
        <caption lang="en">Hall</caption>
        <caption lang="de">Saal</caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
 <!-- }}} -->   
    </message>
    <message name="book-tickets">
<!-- {{{ -->    
      <rng:element name="show_id">
        <caption lang="en">ShowID</caption>
        <caption lang="de">VorstellungsID</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="number_of_persons">
        <caption lang="en">Hall</caption>
        <caption lang="de">Saal</caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
<!-- }}} -->  
    </message>
    <message name="reservation-result">
<!-- {{{ -->      
      <rng:element name="reservation_id">
        <caption lang="en">Reservation ID</caption>
        <caption lang="de">Reservierungsnummer</caption>
        <rng:data type="string"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="popcorn-order">
<!-- {{{ -->      
      <rng:element name="reservation_id">
        <caption lang="en">Reservation ID</caption>
        <caption lang="de">Reservierungsnummer</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="quantity">
        <caption lang="en">Quantity</caption>
        <caption lang="de">Packungen</caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
<!-- }}} --> 
    </message>
    <message name="popcorn-receipt">
<!-- {{{ -->       
      <rng:element name="price">
        <caption lang="en">Preis</caption>
        <caption lang="de">Price</caption>
        <rng:data type="float"/>
      </rng:element>
      <rng:element name="order_number">
        <caption lang="en">Bestellnummer</caption>
        <caption lang="de">Order number</caption>
        <rng:data type="float"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="popcorn-cancelation">
<!-- {{{ -->       
      <rng:element name="order_number">
        <caption lang="en">Bestellnummer</caption>
        <caption lang="de">Order number</caption>
        <rng:data type="string"/>
      </rng:element>
<!-- }}} --> 
    </message>
  </messages>
  <operations>
    <operation name="search" short="search for avaliable shows">
<!-- {{{ -->   
      <endpoints>
        <flow:endpoint id="resource_scope"/>
      </endpoints>
      <context-variables/>
      <execute>
        <flow:call id="find" endpoint="resource_scope" service-operation="search" state-controlflow="execute">
          <flow:input message="search-parameters"/>
          <flow:output message="list-shows"/>
        </flow:call>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} -->   
    </operation>
    <operation name="search_and_book" short="search for shows, select show and book tickets">
<!-- {{{ --> 
      <endpoints>
        <flow:endpoint id="resource_scope"/>
        <flow:endpoint id="selected_cinema"/>
        <flow:endpoint id="selector_service"/>
      </endpoints>
      <context-variables>
      </context-variables>
      <execute>
        <flow:call id="call_find" endpoint="resource_scope" service-operation="search" state-controlflow="execute"/>
        <flow:call id="call_select" endpoint="selector_service" http-method="get" http-status="200" group-by="//show">
          <flow:resource-id xpath="//show/resource-path" endpoint="selected_cinema"/>
          <flow:input name="set" message-parameter="list_of_shows"/>
          <flow:output name="id" message-parameter="show_id"/>
          <flow:output name="movie" message-parameter="movie_title"/>
          <flow:output name="time" message-parameter="starting_time"/>
          <flow:output name="hall" message-parameter="hall"/>
        </flow:call>
        <flow:call id="call_book" endpoint="selected_cinema" service-operation="book" state-controlflow="execute"/>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} -->  
    </operation>
    <operation name="book" short="book tickets for a given show and cinema">
<!-- {{{ -->   
      <endpoints>
        <flow:endpoint id="resource_scope"/>
        <flow:endpoint id="survey_service">http://survey.com/cinema-repo-service</flow:endpoint>
      </endpoints>
      <context-variables/>
      <execute>
        <flow:call id="survey" endpoint="survey_service" http-method="post" http-status="200">
          <flow:input name="vendor" fix-value="RESCUE"/>
        </flow:call>
        <flow:call id="book" endpoint="resource_scope" service-operation="book" state-controlflow="execute">
          <flow:input message="book-tickets"/>
          <flow:output message="reservation-result"/>
        </flow:call>
      </execute>
      <compensate/>
      <undo>
      </undo>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} -->        
    </operation>
    <operation name="popcorn" short="get popcorn to your seat">
<!-- {{{ -->     
      <endpoints>
        <flow:endpoint id="resource_scope"/>
      </endpoints>
      <context-variables/>
      <execute>
        <flow:call id="order_popcorn" endpoint="resource_scope" service-operation="popcorn" state-controlflow="execute">
          <flow:input message="popcorn-order"/>
          <flow:output message="popcorn-resceipt"/>
        </flow:call>
      </execute>
      <compensate/>
      <undo>
        <flow:call id="order_popcorn" endpoint="resource_scope" service-operation="popcorn" state-controlflow="undo">
          <flow:input message="popcorn-cancelation"/>
        </flow:call>
      </undo>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} -->      
    </operation>
  </operations>
</domain-description>

