<?xml version="1.0"?>

<domain-description  xmlns="http://rescue.org/ns/domain/0.2"
            xmlns:rng="http://relaxng.org/ns/structure/1.0"
            xmlns:flow="http://rescue.org/ns/controlflow/0.2">
  <properties>
<!-- {{{ -->
    <rng:element name="longitude">
      <caption lang="en">Longitude</caption>
      <caption lang="de">LÃ¤ngengrad</caption>
      <rng:data type="positiveInteger"/>
    </rng:element>
    <rng:element name="latitude">
      <caption lang="en">Latitude</caption>
      <caption lang="de">Breitengrad</caption>
      <rng:data type="positiveInteger"/>
    </rng:element>
<!-- }}} -->
  </properties>
  <messages>
    <message name="search_parameters">
<!-- {{{ -->     
      <rng:element name="title">
        <caption lang="en">Title</caption>
        <caption lang="de">Titel</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="date">
        <caption lang="en">Date</caption>
        <caption lang="de">Datum</caption>
        <rng:data type="date"/>
      </rng:element>
      <rng:element name="preferred_time">
        <caption lang="en">preferred time</caption>
        <caption lang="de">bevorzugte Zeit</caption>
        <rng:data type="time"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="list_shows">
<!-- {{{ -->     
      <rng:zeroOrMore>
        <rng:element name="show">
          <rng:element name="cinema_uri">
            <caption lang="en">Kino-WWW</caption>
            <caption lang="de">Cinema-URI</caption>
            <rng:data type="string"/>
          </rng:element>
          <rng:element name="movie_title">
            <caption lang="en">Movietitle</caption>
            <caption lang="de">Filmtitel</caption>
            <rng:data type="string"/>
          </rng:element>
          <rng:element name="show_id">
            <caption lang="en">ShowID</caption>
            <caption lang="de">VorstellungsID</caption>
            <rng:data type="string"/>
          </rng:element>
          <rng:element name="starting_time">
            <caption lang="en">Starting time</caption>
            <caption lang="de">Beginzeit</caption>
            <rng:data type="time"/>
          </rng:element>
          <rng:element name="hall">
            <caption lang="en">Hall</caption>
            <caption lang="de">Saal</caption>
            <rng:data type="positiveInteger"/>
          </rng:element>
        </rng:element>
      </rng:zeroOrMore>
<!-- }}} -->
    </message>
    <message name="selected_show">
<!-- {{{ -->    
      <rng:element name="movie_title">
        <caption lang="en">Movietitle</caption>
        <caption lang="de">Filmtitel</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="show_id">
        <caption lang="en">ShowID</caption>
        <caption lang="de">VorstellungsID</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="starting_time">
        <caption lang="en">Starting time</caption>
        <caption lang="de">Beginzeit</caption>
        <rng:data type="time"/>
      </rng:element>
      <rng:element name="hall">
        <caption lang="en">Hall</caption>
        <caption lang="de">Saal</caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
<!-- }}} --> 
    </message>
    <message name="book_tickets">
<!-- {{{ -->    
      <rng:element name="show_id">
        <caption lang="en">ShowID</caption>
        <caption lang="de">VorstellungsID</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="number_of_persons">
        <caption lang="en">Hall</caption>
        <caption lang="de">Saal</caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
<!-- }}} --> 
    </message>
    <message name="reservation_result">
<!-- {{{ -->     
      <rng:element name="reservation_id">
        <caption lang="en">Reservation ID</caption>
        <caption lang="de">Reservierungsnummer</caption>
        <rng:data type="string"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="order_popcorn">
<!-- {{{ -->      
      <rng:element name="reservation_id">
        <caption lang="en">Reservation ID</caption>
        <caption lang="de">Reservierungsnummer</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="quantity">
        <caption lang="en">Quantity</caption>
        <caption lang="de">Packungen</caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="popcorn_result">
<!-- {{{ -->      
      <rng:element name="price">
        <caption lang="en">Preis</caption>
        <caption lang="de">Price</caption>
        <rng:data type="float"/>
      </rng:element>
<!-- }}} -->
    </message>
  </messages>
  <operations>
    <variables>
      <flow:context id="empty"/>
    </variables>
    <endpoints>
  <!-- {{{ --> 
      <flow:endpoint id="resource_path"/>
      <flow:endpoint id="selected_cinema">bla</flow:endpoint>
      <flow:endpoint id="selector_service"/>
  <!-- }}} -->
    </endpoints>
    <operation name="search" short="search for avaliable shows">
<!-- {{{ -->   
      <execute>
        <flow:call id="find" endpoint="resource_scope" service-operation="search" state-controlflow="execute">
          <flow:input message="search_parameters"/>
          <flow:output message="list_shows"/>
        </flow:call>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} -->  
    </operation>
    <operation name="search_and_book" short="search for shows, select show and book tickets">
<!-- {{{ --> 
      <execute>
        <flow:call id="call_find" endpoint="resource_scope" service-operation="search" state-controlflow="execute"/>
        <flow:call id="call_select" endpoint="selector_service" http-method="get" http-status="200" group-by="//show">
          <flow:resource-id xpath="//show/cinema_uri" endpoint="selected_cinema"/>
          <flow:input message="list_shows"/>
          <flow:output message="selected_show"/>
        </flow:call>
        <flow:call id="call_book" endpoint="selected_cinema_uri" service-operation="book" state-controlflow="execute"/>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} --> 
    </operation>
    <operation name="book" short="book tickets for a given show and cinema">
<!-- {{{ -->   
      <execute>
        <flow:call id="call_book" endpoint="resource_scope" service-operation="popcorn" state-controlflow="execute">
          <flow:input message="book_tickets"/>
          <flow:output message="reservation_result"/>
        </flow:call>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} -->       
    </operation>
    <operation name="order-popcorn" short="get popcorn to your seat">
<!-- {{{ -->    
      <execute>
        <flow:choose>
          <flow:alternative>
            <flow:condition test="selected_cinema" operator="!=" fix-value="nil"/>
            <flow:call id="order_popcorn" endpoint="selected_cinema" service-operation="popcorn" state-controlflow="execute">
              <flow:input message="popcorn_order"/>
              <flow:output message="popcorn_result"/>
            </flow:call>
          </flow:alternative>
        </flow:choose>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} -->      
    </operation>
  </operations>
</domain-description>

