#!/usr/bin/ruby
require '../../lib/ruby/client'
require 'rubygems'
require 'xml/smart'


client = Riddl::Client.new("http://localhost:9290")

create = true
validate = true
delete = true
update = true
rename = true

ARGV.each do |a|
  case a
    when "--skip-create" then create = false
    when "--skip-delete" then delete = false
    when "--skip-validate" then validate = false
    when "--skip-update" then update = false
    when "--skip-rename" then rename = false
    else puts "Unknown command #{a}"
  end
end

# Testcases for adding resources
if create
puts "Starting create-tests"
# {{{
expectation = 501
test = "Creating group with a invalide XML (expected status: #{expectation})"
# {{{
status, response = client.resource("groups").post [
      Riddl::Parameter::Simple.new("group-name", "testclient-group-invalide-xml"),
      Riddl::Parameter::Complex.new("interface", "text/xml", File.open("example-cinema/service.xml", "r"))
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 201
test= "Creating group with valide XML (expected status: #{expectation})"
# {{{
status, response = client.resource("groups").post [
      Riddl::Parameter::Simple.new("group-name", "testclient-group"),
      Riddl::Parameter::Complex.new("interface", "text/xml", File.open("example-cinema/group.xml", "r"))
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 409
test = "Creating group with a name that already exists (expected status: #{expectation})"
# {{{
status, response = client.resource("groups").post [
      Riddl::Parameter::Simple.new("group-name", "testclient-group"),
      Riddl::Parameter::Complex.new("interface", "text/xml", File.open("example-cinema/group.xml", "r"))
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}


expectation = 201
test = "Creating subgroup (expected status: #{expectation})"
# {{{zo
status, response = client.resource("groups/testclient-group").post [
      Riddl::Parameter::Simple.new("subgroup-name", "testclient-subgroup")
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 409
test = "Creating subgroup with a name that already exists (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group").post [
      Riddl::Parameter::Simple.new("subgroup-name", "testclient-subgroup")
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}


expectation = 415
test = "Creating service with invalide XML (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group/testclient-subgroup/").post [
      Riddl::Parameter::Simple.new("service-name", "testclient-service-invalide-xml"),
      Riddl::Parameter::Complex.new("properties", "text/xml", File.open("example-cinema/group.xml", "r"))
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 201
test = "Creating service with valide XML (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group/testclient-subgroup").post [
      Riddl::Parameter::Simple.new("service-name", "testclient-service"),
      Riddl::Parameter::Complex.new("properties", "text/xml", File.open("example-cinema/service.xml", "r"))
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 409
test = "Creating service with a name that already exists (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group/testclient-subgroup").post [
      Riddl::Parameter::Simple.new("service-name", "testclient-service"),
      Riddl::Parameter::Complex.new("properties", "text/xml", File.open("example-cinema/service.xml", "r"))
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}
end
# }}}

# Testcases for requesting reources
if validate
puts "Starting validation-test"
# {{{
test = "Validating serviceSchema against service-properties"
# {{{
status, response = client.resource("groups/testclient-group").get [Riddl::Parameter::Simple.new("serviceSchema","")]
schema = XML::Smart.string(response[0].value.read)
puts test + " failed during requesting properties schema with status-code: #{status}" if status != 200
status, response = client.resource("groups/testclient-group/testclient-subgroup/testclient-service").get []
xml = XML::Smart.string(response[0].value.read)
puts "\tTesting serviceSchema"
puts test + " failed during requesting service-properties with status-code: #{status}" if status != 200
puts test + " failed because schema does not match against xml"  if xml.validate_against(schema) == false

# Looping through each operation and check if messages are valid
operations = schema.find("//rng:element[@name='service:operations']/rng:element", {"rng" => "http://relaxng.org/ns/structure/1.0"})

operations.each do |o|
  operation =  o.attributes.get_attr("name").value.split(":")[1]
  puts "\tTesting #{operation}-input-message"
  message ="Validating \"example-cinema/#{operation}-#{message}.xml\" against schema for input"
  status, response = client.resource("groups/testclient-group/operations/#{operation}").get [Riddl::Parameter::Simple.new("input","")]
  schema = XML::Smart.string(response[0].value.read)
  puts test + " failed during requesting input-message schema for #{operation} with status-code: #{status}" if status != 200
  xml = XML::Smart.open("example-cinema/#{operation}-input.xml")
  puts message + " failed" if xml.validate_against(schema) == false
end
#}}}
end
# }}}


# Testcases for updating
if update
puts "Starting update-tests"
# {{{
expectation = 415
test = "Updating service with invalide XML (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group/testclient-subgroup/testclient-service").put [
      Riddl::Parameter::Complex.new("properties", "text/xml", File.open("example-cinema/group.xml", "r"))
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 200
test = "Updating service with valide XML (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group/testclient-subgroup/testclient-service").put [
      Riddl::Parameter::Complex.new("properties", "text/xml", File.open("example-cinema/service.xml", "r"))
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}
end
# }}}


# Testcases for renaming resources
if rename
puts "Start renaming-tests"
# {{{
expectation = 200
test = "Renaming group (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group/").put [
      Riddl::Parameter::Simple.new("new-name", "testclient-group-renamed")
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 200
test = "Renaming subggroup (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group-renamed/testclient-subgroup").put [
      Riddl::Parameter::Simple.new("new-name", "testclient-subgroup-renamed")
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 200
test = "Renaming service (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group-renamed/testclient-subgroup-renamed/testclient-service").put [
      Riddl::Parameter::Simple.new("new-name", "testclient-service-renamed")
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 409
test = "Renaming group with a name that already exists (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group/").put [
      Riddl::Parameter::Simple.new("new-name", "testclient-group-renamed")
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 409
test = "Renaming subggroup with a name that already exists (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group-renamed/testclient-subgroup").put [
      Riddl::Parameter::Simple.new("new-name", "testclient-subgroup-renamed")
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 409
test = "Renaming service with a name that already exists (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group-renamed/testclient-subgroup-renamed/testclient-service").put [
      Riddl::Parameter::Simple.new("new-name", "testclient-service-renamed")
      ]
puts test + " failed with error: #{status}" if status != expectation
# }}}
end
# }}}



# Testcases for deleting resources
if delete
puts "Starting delete-tests"
# {{{
expectation = 200
test= "Deleting service (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group-renamed/testclient-subgroup-renamed/testclient-service-renamed").delete []
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 200
test= "Deleting subgroup (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group-renamed/testclient-subgroup-renamed").delete []
puts test + " failed with error: #{status}" if status != expectation
# }}}

expectation = 200
test= "Deleting group (expected status: #{expectation})"
# {{{
status, response = client.resource("groups/testclient-group-renamed").delete []
puts test + " failed with error: #{status}" if status != expectation
# }}}
end
# }}}
