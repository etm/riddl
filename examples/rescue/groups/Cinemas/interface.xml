<?xml version="1.0"?>

<domain-description  xmlns="http://rescue.org/ns/domain/0.2"
            xmlns:domain="http://rescue.org/ns/domain/0.2"
            xmlns:rng="http://relaxng.org/ns/structure/1.0">
  <properties>
<!-- {{{ -->
    <rng:element name="address">
      <domain:caption xml:lang="EN">Address</domain:caption>
      <domain:caption xml:lang="DE">Adresse</domain:caption>
      <rng:element name="street">
        <domain:caption xml:lang="EN">Street</domain:caption>
        <domain:caption xml:lang="DE">Stra√üe</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="zip">
        <domain:caption xml:lang="EN">ZIP</domain:caption>
        <domain:caption xml:lang="DE">PLZ</domain:caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
      <rng:element name="city">
        <domain:caption xml:lang="EN">City</domain:caption>
        <domain:caption xml:lang="DE">Stadt</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="state">
        <domain:caption xml:lang="EN">State</domain:caption>
        <domain:caption xml:lang="DE">Land</domain:caption>
        <rng:data type="string"/>
      </rng:element>
    </rng:element>
    <rng:element name="vendor">
      <domain:caption xml:lang="EN">Vendor</domain:caption>
      <domain:caption xml:lang="DE">Anbieter</domain:caption>
      <rng:element name="name">
        <domain:caption xml:lang="EN">Name</domain:caption>
        <domain:caption xml:lang="DE">Name</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="phone">
        <domain:caption xml:lang="EN">Phone</domain:caption>
        <domain:caption xml:lang="DE">Telephon</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="url">
        <domain:caption xml:lang="EN">URL</domain:caption>
        <domain:caption xml:lang="DE">URL</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="mail">
        <domain:caption xml:lang="EN">@mail</domain:caption>
        <domain:caption xml:lang="DE">@mail</domain:caption>
        <rng:data type="string"/>
      </rng:element>
    </rng:element>
<!-- }}} -->
  </properties>
  <operations>
    <operation name="search" short="search for available shows" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ -->   
      <execute>
        <call id="perform_search" endpoint="resource_path" service-operation="search">
<!-- {{{ -->   
          <input name="title" message-parameter="title">
<!-- {{{ -->     
            <rng:element name="title">
              <domain:caption xml:lang="EN">Movietitle</domain:caption>
              <domain:caption xml:lang="DE">Filmtitel</domain:caption>
              <rng:data type="string"/>
            </rng:element>
<!-- }}} --> 
          </input>
          <input name="date" message-parameter="date">
<!-- {{{ -->     
            <rng:element name="date">
              <domain:caption xml:lang="EN">Date</domain:caption>
              <domain:caption xml:lang="DE">Datum</domain:caption>
              <rng:data type="date"/>
            </rng:element>
<!-- }}} --> 
          </input>
          <output name="list" message-parameter="list_shows">
<!-- {{{ -->     
            <rng:element name="list_of_shows">
              <domain:caption xml:lang="EN">List of Shows</domain:caption>
              <domain:caption xml:lang="DE">Liste der Vorstellungen</domain:caption>
              <rng:zeroOrMore>
                <rng:element name="show">
                  <domain:caption xml:lang="EN">Show</domain:caption>
                  <domain:caption xml:lang="DE">Vorstellung</domain:caption>
                  <rng:element name="cinema_uri">
                    <domain:caption xml:lang="EN">Cinema URI</domain:caption>
                    <domain:caption xml:lang="DE">Kino URI</domain:caption>
                    <rng:data type="string"/>
                  </rng:element>
                  <rng:element name="show_id">
                    <domain:caption xml:lang="EN">Show ID</domain:caption>
                    <domain:caption xml:lang="DE">VorstellungsID</domain:caption>
                    <rng:data type="string"/>
                  </rng:element>
                  <rng:element name="title">
                    <domain:caption xml:lang="EN">Title</domain:caption>
                    <domain:caption xml:lang="DE">Titel</domain:caption>
                    <rng:data type="string"/>
                  </rng:element>
                  <rng:element name="date">
                    <domain:caption xml:lang="EN">Date</domain:caption>
                    <domain:caption xml:lang="DE">Datum</domain:caption>
                    <rng:data type="date"/>
                  </rng:element>
                  <rng:element name="time">
                    <domain:caption xml:lang="EN">Starting Time</domain:caption>
                    <domain:caption xml:lang="DE">Startzeit</domain:caption>
                    <rng:data type="time"/>
                  </rng:element>
                  <rng:element name="hall">
                    <domain:caption xml:lang="EN">Hall</domain:caption>
                    <domain:caption xml:lang="DE">Saal</domain:caption>
                    <rng:data type="string"/>
                  </rng:element>
                </rng:element>
              </rng:zeroOrMore>
            </rng:element>
<!-- }}} --> 
          </output>
<!-- }}} -->  
        </call>
      </execute>
<!-- }}} -->  
    </operation>
    <operation name="search_and_book" short="search for shows, select show and book tickets" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ --> 
      <data-elements>
        <show_id/>
        <list/>
        <res/>
        <list_merge/>
        <number_of_shows/>
        <endpoint/>
      </data-elements>
      <endpoints>
        <selected_cinema/>
      </endpoints>
      <execute>
        <call id="call_find" endpoint="resource_path" service-operation="search">
<!-- {{{ -->  
          <input name="title" message-parameter="title">
<!-- {{{ -->  
            <rng:element name="title">
              <domain:caption xml:lang="EN">Movietitle</domain:caption>
              <domain:caption xml:lang="DE">Filmtitel</domain:caption>
              <rng:data type="string"/>
            </rng:element>
<!-- }}} -->  
          </input>
          <input name="date" message-parameter="date">
<!-- {{{ -->  
            <rng:element name="date">
              <domain:caption xml:lang="EN">Date</domain:caption>
              <domain:caption xml:lang="DE">Datum</domain:caption>
              <rng:data type="date"/>
            </rng:element>
<!-- }}} -->   
          </input>
          <output name="list" variable="list"/>
<!-- }}} -->   
        </call>
        <manipulate id="merge_result">
<!-- {{{ --> 
          <variable context="list" local="list"/>
          <variable context="list_merge" local="m_list"/>
          <variable context="number_of_shows" local="nos"/>
          <variable input-parameter="title" local="title"/>
          <variable input-parameter="date" local="date"/>
          xml = XML::Smart.string("&lt;list_of_shows/&gt;")
          if list.class == Array
            list.each do |v|
              l = XML::Smart.string(v)
              xml.root.add(l.find("//show"))
            end
          elsif list.class == String
            l = XML::Smart.string(list)
            xml.root.add(l.find("//show"))
          else
            raise "Unexpected class of return-value - class: #{list.class}"
          end
          m_list = xml.root.dump
          nos = xml.root.children.length
<!-- }}} -->  
        </manipulate>
        <choose>
          <alternative>
            <condition test="number_of_shows" comparator="&gt;" value="0"/>
            <call id="perform_select" endpoint="selector_service" endpoint-type="outside" http-method="post" info="true" default-tpl-name="Select_Show" default-tpl-lang="EN">
              <!-- {{{ --> 
              <templates>
                <xslt name="Select_Show" xml:lang="DE" platform="iPhone"><!-- {{{ -->
                  <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
                    <xsl:output method="html"/>
                    <xsl:template match="/">
                      <xsl:apply-templates select="//show"/>
                      <script type="text/javascript">
                        function send_selection(data, callback) {
                          $.ajax({
                            url: callback,
                            type: 'put',
                            dataType: 'text',
                            data: data,
                            success: function(res){
                              jQT.goBack();
                            },
                            error: function() {alert('Unable to send data to instance ' + callback);}
                          });
                        }
                      </script>                        
                    </xsl:template>
                    <xsl:template match="//show">
                      <ul>
                        <li style="font-weight:normal"><b>Kino:</b><xsl:value-of select="cinema_uri"/></li>
                        <li style="font-weight:normal"><b>Filmtitel:</b><xsl:value-of select="title"/></li>
                        <li style="font-weight:normal"><b>Beginzeit:</b><xsl:value-of select="time"/></li>
                        <li style="font-weight:normal"><b>Datum:</b><xsl:value-of select="date"/></li>
                        <li style="font-weight:normal"><b>Saal:</b><xsl:value-of select="hall"/></li>
                          <xsl:element name="li">
                            <xsl:attribute name="class">blueButton</xsl:attribute>
                            <xsl:attribute name="style">text-align:center;color:</xsl:attribute>
                            <xsl:attribute name="onClick">JavaScript:send_selection({
                              'show_id' : '<xsl:value-of select="show_id"/>',
                              'target' : '<xsl:value-of select="cinema_uri"/>',
                              'movie_title' : '<xsl:value-of select="title"/>',
                              'date' : '<xsl:value-of select="date"/>',
                              'starting_time' : '<xsl:value-of select="time"/>',
                              'hall' : '<xsl:value-of select="hall"/>'
                            },'<xsl:value-of select="$instance-uri"/>/callbacks/<xsl:value-of select="$callback-id"/>');
                            </xsl:attribute>
                            Select Show
                          </xsl:element>
                      </ul>
                    </xsl:template>
                  </xsl:stylesheet>
                </xslt><!-- }}} -->
                <xslt name="Select_Show" xml:lang="EN" platform="iPhone"><!-- {{{ -->
                  <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
                    <xsl:output method="html"/>
                    <xsl:template match="/">
                      <xsl:apply-templates select="//show"/>
                      <script type="text/javascript">
                        function send_selection(data, callback) {
                          $.ajax({
                            url: callback,
                            type: 'put',
                            dataType: 'text',
                            data: data,
                            success: function(res){
                              jQT.goBack();
                            },
                            error: function() {alert('Unable to send data to instance ' + callback);}
                          });
                        }
                      </script>                        
                    </xsl:template>
                    <xsl:template match="//show">
                      <ul>
                        <li style="font-weight:normal"><b>Cinema:</b><xsl:value-of select="cinema_uri"/></li>
                        <li style="font-weight:normal"><b>Movietitle:</b><xsl:value-of select="title"/></li>
                        <li style="font-weight:normal"><b>Starting time:</b><xsl:value-of select="time"/></li>
                        <li style="font-weight:normal"><b>Date:</b><xsl:value-of select="date"/></li>
                        <li style="font-weight:normal"><b>Hall:</b><xsl:value-of select="hall"/></li>
                          <xsl:element name="li">
                            <xsl:attribute name="class">blueButton</xsl:attribute>
                            <xsl:attribute name="style">text-align:center;color:</xsl:attribute>
                            <xsl:attribute name="onClick">JavaScript:send_selection({
                              'show_id' : '<xsl:value-of select="show_id"/>',
                              'target' : '<xsl:value-of select="cinema_uri"/>',
                              'movie_title' : '<xsl:value-of select="title"/>',
                              'date' : '<xsl:value-of select="date"/>',
                              'starting_time' : '<xsl:value-of select="time"/>',
                              'hall' : '<xsl:value-of select="hall"/>'
                            },'<xsl:value-of select="$instance-uri"/>/callbacks/<xsl:value-of select="$callback-id"/>');
                            </xsl:attribute>
                            Select Show
                          </xsl:element>
                      </ul>
                    </xsl:template>
                  </xsl:stylesheet>
                </xslt><!-- }}} -->
                <xslt name="Select_Show" xml:lang="DE" platform="Browser"><!-- {{{ -->
                  <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
                    <xsl:output method="html"/>
                    <xsl:template match="/">
                      <xsl:apply-templates select="//show"/>
                      <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.min.js"/>
                      <script type="text/javascript">
                        function send_selection(data, callback) {
                          $.ajax({
                            url: callback,
                            type: 'put',
                            dataType: 'text',
                            data: data,
                            success: function(res){
                              window.setTimeout("window.location.replace('<xsl:value-of select="$worklist"/>');", 500);
                            },
                            error: function() {alert('Unable to send data to instance ' + callback);}
                          });
                        }
                      </script>                        
                    </xsl:template>
                    <xsl:template match="//show">
                      <ul>
                        <li style="font-weight:normal"><b>Kino:</b><xsl:value-of select="cinema_uri"/></li>
                        <li style="font-weight:normal"><b>Filmtitel:</b><xsl:value-of select="title"/></li>
                        <li style="font-weight:normal"><b>Beginzeit:</b><xsl:value-of select="time"/></li>
                        <li style="font-weight:normal"><b>Datum:</b><xsl:value-of select="date"/></li>
                        <li style="font-weight:normal"><b>Saal:</b><xsl:value-of select="hall"/></li>
                          <xsl:element name="input">
                            <xsl:attribute name="type">button</xsl:attribute>
                            <xsl:attribute name="Value">Vorstellung auswaehlen</xsl:attribute>
                            <xsl:attribute name="style">text-align:center;color:</xsl:attribute>
                            <xsl:attribute name="onClick">JavaScript:send_selection({
                              'show_id' : '<xsl:value-of select="show_id"/>',
                              'target' : '<xsl:value-of select="cinema_uri"/>',
                              'movie_title' : '<xsl:value-of select="title"/>',
                              'date' : '<xsl:value-of select="date"/>',
                              'starting_time' : '<xsl:value-of select="time"/>',
                              'hall' : '<xsl:value-of select="hall"/>'
                            },'<xsl:value-of select="$instance-uri"/>/callbacks/<xsl:value-of select="$callback-id"/>');
                            </xsl:attribute>
                            Select Show
                          </xsl:element>
                      </ul>
                      <hr/>
                    </xsl:template>
                  </xsl:stylesheet>
                </xslt><!-- }}} -->
                <xslt name="Select_Show" xml:lang="EN" platform="Browser"><!-- {{{ -->
                  <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
                    <xsl:output method="html"/>
                    <xsl:template match="/">
                      <xsl:apply-templates select="//show"/>
                      <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.min.js"/>
                      <script type="text/javascript">
                        function send_selection(data, callback) {
                          $.ajax({
                            url: callback,
                            type: 'put',
                            dataType: 'text',
                            data: data,
                            success: function(res){
                              window.setTimeout("window.location.replace('<xsl:value-of select="$worklist"/>');", 500);
                            },
                            error: function() {alert('Unable to send data to instance ' + callback);}
                          });
                        }
                      </script>                        
                    </xsl:template>
                    <xsl:template match="//show">
                      <ul>
                        <li style="font-weight:normal"><b>Cinema:</b><xsl:value-of select="cinema_uri"/></li>
                        <li style="font-weight:normal"><b>Movietitle:</b><xsl:value-of select="title"/></li>
                        <li style="font-weight:normal"><b>Starting time:</b><xsl:value-of select="time"/></li>
                        <li style="font-weight:normal"><b>Date:</b><xsl:value-of select="date"/></li>
                        <li style="font-weight:normal"><b>Hall:</b><xsl:value-of select="hall"/></li>
                          <xsl:element name="input">
                            <xsl:attribute name="type">button</xsl:attribute>
                            <xsl:attribute name="Value">Select Show</xsl:attribute>
                            <xsl:attribute name="style">text-align:center;color:</xsl:attribute>
                            <xsl:attribute name="onClick">JavaScript:send_selection({
                              'show_id' : '<xsl:value-of select="show_id"/>',
                              'target' : '<xsl:value-of select="cinema_uri"/>',
                              'movie_title' : '<xsl:value-of select="title"/>',
                              'date' : '<xsl:value-of select="date"/>',
                              'starting_time' : '<xsl:value-of select="time"/>',
                              'hall' : '<xsl:value-of select="hall"/>'
                            },'<xsl:value-of select="$instance-uri"/>/callbacks/<xsl:value-of select="$callback-id"/>');
                            </xsl:attribute>
                          </xsl:element>
                      </ul>
                      <hr/>
                    </xsl:template>
                  </xsl:stylesheet>
                </xslt><!-- }}} -->
              </templates>
              <input name="data" variable="list_merge"/>
              <output name="show_id" variable="show_id"/>
              <output name="target" variable="endpoint"/>
              <output message-parameter="status" type="status"/>
              <output name="movie_title" message-parameter="movie_title">
                <!-- {{{ --> 
                <rng:element name="movie_title">
                  <domain:caption xml:lang="EN">Title</domain:caption>
                  <domain:caption xml:lang="DE">Titel</domain:caption>
                  <rng:data type="string"/>
                </rng:element>
                <!-- }}} -->  
              </output>
              <output name="date" message-parameter="selected_date">
              <!-- {{{ --> 
                <rng:element name="selected_date">
                  <domain:caption xml:lang="EN">Date</domain:caption>
                  <domain:caption xml:lang="DE">Datum</domain:caption>
                  <rng:data type="date"/>
                </rng:element>
              <!-- }}} -->   
              </output>
              <output name="starting_time" message-parameter="starting_time">
              <!-- {{{ --> 
                <rng:element name="starting_time">
                  <domain:caption xml:lang="EN">Starting Time</domain:caption>
                  <domain:caption xml:lang="DE">Startzeit</domain:caption>
                  <rng:data type="time"/>
                </rng:element>
              <!-- }}} -->  
              </output>
              <output name="hall" message-parameter="hall">
              <!-- {{{ --> 
                <rng:element name="hall">
                  <domain:caption xml:lang="EN">Hall</domain:caption>
                  <domain:caption xml:lang="DE">Saal</domain:caption>
                  <rng:data type="positiveInteger"/>
                </rng:element>
              <!-- }}} -->  
              </output>
            <!-- }}} -->  
            </call>
            <manipulate id="set_selected_endpoint">
              <variable context="endpoint" local="ep"/>
              <variable endpoint="selected_cinema" local="selected"/>
              selected = ep
            </manipulate>
            <call id="call_book" endpoint="selected_cinema" service-operation="book">
            <!-- {{{ -->   
              <input name="show_id" variable="show_id"/>
              <output name="reservation_number" message-parameter="reservation_id">
              <!-- {{{ -->      
                <rng:element name="reservation_id">
                  <domain:caption xml:lang="EN">Reservation number</domain:caption>
                  <domain:caption xml:lang="DE">Reservierungsnummer</domain:caption>
                  <rng:data type="string"/>
                </rng:element>
               <!-- }}} --> 
              </output>
            <!-- }}} --> 
            </call>
            <manipulate id="set_status_success">
              <variable output-parameter="status" local="status">
                <rng:element name="status">
                  <rng:data type="positiveInteger"/>
                </rng:element>
              </variable>
              status = 200
            </manipulate>
          </alternative>
          <otherwise>
            <manipulate id="set_status_failed">
              <variable output-parameter="status" local="status">
                <rng:element name="status">
                  <rng:data type="positiveInteger"/>
                </rng:element>
              </variable>
              status = 404
            </manipulate>
          </otherwise>
        </choose>
      </execute>
<!-- }}} --> 
    </operation>
    <operation name="book" short="book tickets for a given show and cinema" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ -->     
      <execute>
        <call id="perform_book" endpoint="resource_path" service-operation="book" state-controlflow="execute">
<!-- {{{ -->     
          <input name="show_id" message-parameter="show_id">
<!-- {{{ -->     
            <rng:element name="show_id">
              <domain:caption xml:lang="EN">ShowID</domain:caption>
              <domain:caption xml:lang="DE">VorstellungsID</domain:caption>
              <rng:data type="string"/>
            </rng:element>
<!-- }}} --> 
          </input>
          <output name="reservation_id" message-parameter="reservation_number">
<!-- {{{ -->     
            <rng:element name="reservation_id">
              <domain:caption xml:lang="EN">Reservation number</domain:caption>
              <domain:caption xml:lang="DE">Reservierungsnummer</domain:caption>
              <rng:data type="string"/>
            </rng:element>
<!-- }}} --> 
          </output>
<!-- }}} -->       
        </call>
      </execute>
<!-- }}} -->       
    </operation>
  </operations>
</domain-description>

