<?xml version="1.0"?>

<domain-description  xmlns="http://rescue.org/ns/domain/0.2"
            xmlns:rng="http://relaxng.org/ns/structure/1.0"
            xmlns:flow="http://rescue.org/ns/controlflow/0.2">
  <properties>
<!-- {{{ -->
    <rng:element name="longitude">
      <caption lang="en">Longitude</caption>
      <caption lang="de">LÃ¤ngengrad</caption>
      <rng:data type="positiveInteger"/>
    </rng:element>
    <rng:element name="latitude">
      <caption lang="en">Latitude</caption>
      <caption lang="de">Breitengrad</caption>
      <rng:data type="positiveInteger"/>
    </rng:element>
    <rng:element name="carpark">
      <caption lang="en">Carpark</caption>
      <caption lang="de">Parkplatz</caption>
      <rng:data type="boolean"/>
    </rng:element>
<!-- }}} -->
  </properties>
  <messages>
    <message name="search_parameters">
<!-- {{{ -->      
      <rng:element name="title">
        <caption lang="en">Title</caption>
        <caption lang="de">Titel</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="date">
        <caption lang="en">Date</caption>
        <caption lang="de">Datum</caption>
        <rng:data type="date"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="list_shows">
<!-- {{{ -->     
      <rng:element name="list">
        <rng:zeroOrMore>
          <rng:element name="show">
            <rng:element name="show_id">
              <caption lang="en">ShowID</caption>
              <caption lang="de">VorstellungsID</caption>
              <rng:data type="string"/>
            </rng:element>
            <rng:element name="title">
              <caption lang="en">Movietitle</caption>
              <caption lang="de">Filmtitel</caption>
              <rng:data type="string"/>
            </rng:element>
            <rng:element name="time">
              <caption lang="en">Starting time</caption>
              <caption lang="de">Beginzeit</caption>
              <rng:data type="time"/>
            </rng:element>
          </rng:element>
        </rng:zeroOrMore>
      </rng:element>
<!-- }}} --> 
    </message>
    <message name="selected_show">
<!-- {{{ -->    
      <rng:element name="movie_title">
        <caption lang="en">Movietitle</caption>
        <caption lang="de">Filmtitel</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="show_id">
        <caption lang="en">ShowID</caption>
        <caption lang="de">VorstellungsID</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="starting_time">
        <caption lang="en">Starting time</caption>
        <caption lang="de">Beginzeit</caption>
        <rng:data type="time"/>
      </rng:element>
      <rng:element name="hall">
        <caption lang="en">Hall</caption>
        <caption lang="de">Saal</caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
<!-- }}} -->  
    </message>
    <message name="book_tickets">
<!-- {{{ -->    
      <rng:element name="show_id">
        <caption lang="en">ShowID</caption>
        <caption lang="de">VorstellungsID</caption>
        <rng:data type="string"/>
      </rng:element>
<!-- }}} --> 
    </message>
    <message name="reservation_result">
<!-- {{{ -->     
      <rng:element name="reservation_id">
        <caption lang="en">Reservation ID</caption>
        <caption lang="de">Reservierungsnummer</caption>
        <rng:data type="string"/>
      </rng:element>
<!-- }}} --> 
    </message>
    <message name="popcorn_order">
<!-- {{{ -->      
      <rng:element name="reservation_id">
        <caption lang="en">Reservation ID</caption>
        <caption lang="de">Reservierungsnummer</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="quantity">
        <caption lang="en">Quantity</caption>
        <caption lang="de">Packungen</caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="popcorn_result">
<!-- {{{ -->      
      <rng:element name="price">
        <caption lang="en">Preis</caption>
        <caption lang="de">Price</caption>
        <rng:data type="float"/>
      </rng:element>
      <rng:element name="order_number">
        <caption lang="en">Bestellnummer</caption>
        <caption lang="de">Order number</caption>
        <rng:data type="float"/>
      </rng:element>
<!-- }}} -->
    </message>
    <message name="undo_popcorn">
<!-- {{{ -->      
      <rng:element name="order_number">
        <caption lang="en">Bestellnummer</caption>
        <caption lang="de">Order number</caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="quantity">
        <caption lang="en">Quantity</caption>
        <caption lang="de">Packungen</caption>
        <rng:data type="boolean"/>
      </rng:element>
<!-- }}} --> 
    </message>
  </messages>
  <operations>
    <operation name="search" short="search for avaliable shows" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ -->   
      <execute>
        <flow:call id="perform_search" endpoint="resource_path" service-operation="search">
          <flow:input message="search_parameters"/>
          <flow:output message="list_shows"/>
        </flow:call>
      </execute>
<!-- }}} -->  
    </operation>
    <operation name="search_and_book" short="search for shows, select show and book tickets" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ --> 
      <context-variables>
        <show_id>BAL_4711</show_id>
        <list/>
        <res/>
        <list_merge>''</list_merge>
      </context-variables>
      <endpoints>
        <selected_cinema/>
      </endpoints>
      <execute>
        <flow:call id="call_find" endpoint="resource_path" service-operation="search">
          <flow:input name="title" message-parameter="title"/>
          <flow:input name="date" message-parameter="date"/>
          <flow:output name="list" variable="list"/>
        </flow:call>
        <flow:manipulate id="merge_result" context="list, list_merge" output="list, m_list">
          puts m_list
          xml = XML::Smart.string("&lt;list_of_shows/&gt;")
          list.each do |k,v|
            l = XML::Smart.string(v)
            xml.root.add(l.find("//show"))
          end
          m_list.clear
          m_list &lt;&lt; xml.to_s
        </flow:manipulate>
        <flow:call id="perform_select" endpoint="selector_service" endpoint-type="outside" http-method="get" group-by="//show">
          <flow:resource-id xpath="cinema_uri" endpoint="selected_cinema" name="target"/>
          <flow:input name="data" variable="list_merge"/>
          <flow:output name="movie_title" message-parameter="movie_title" type="simple"/>
          <flow:output name="hall" message-parameter="hall" type="simple"/>
          <flow:output name="starting_time" message-parameter="starting_time" type="simple"/>
          <flow:output name="show_id" variable="show_id" type="simple"/>
        </flow:call>
        <flow:call id="call_book" endpoint="selected_cinema" service-operation="book">
          <flow:input name="show_id" variable="show_id"/>
          <flow:output name="reservation_id" message-parameter="reservation_id" type="simple"/>
        </flow:call>
      </execute>
      <abort/>
<!-- }}} --> 
    </operation>
    <operation name="book" short="book tickets for a given show and cinema" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ -->     
      <execute>
        <flow:call id="perform_book" endpoint="resource_path" service-operation="book" state-controlflow="execute">
          <flow:input message="book_tickets"/>
          <flow:output message="reservation_result"/>
        </flow:call>
      </execute>
<!-- }}} -->       
    </operation>
    <operation name="order_popcorn" short="get popcorn to your seat" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ -->    
      <execute>
        <flow:call id="perform_order_popcorn" endpoint="resource_scope" service-operation="order_popcorn" state-controlflow="execute">
          <flow:input message="popcorn_order"/>
          <flow:output message="popcorn_result"/>
        </flow:call>
      </execute>
      <compensate/>
      <undo>
        <flow:call id="perform_order_popcorn" endpoint="resource_scope" service-operation="order_popcorn" state-controlflow="undo">
          <flow:input message="popcorn_undo"/>
        </flow:call>
      </undo>
      <redo/>
      <suspend/>
      <abort/>
<!-- }}} -->      
    </operation>
  </operations>
</domain-description>

