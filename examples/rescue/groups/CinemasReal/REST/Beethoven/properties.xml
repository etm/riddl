<?xml version="1.0"?>

<service-description xmlns="http://rescue.org/ns/service/0.2"
                 xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <properties xmlns="http://rescue.org/ns/properties/0.2">
    <adress>
      <street>Beethovenstra√üe 2a</street>
      <zip>2500</zip>
      <city>Baden</city>
      <state>Austria</state>
    </adress>
    <vendor>
      <name>Beethoven Kino</name>
      <phone>+43-2252-48242</phone>
      <url>http://www.cineplexx.at/content/kinos/kinodetails.aspx</url>
      <mail>village.wienmitte@villagekinos.at</mail>
    </vendor>
  </properties>
  <operations xmlns="http://rescue.org/ns/controlflow/0.2">
    <search>
      <endpoints>
        <service>http://www.cineplexx.at/content/kinos/kinoprogramm.aspx</service>
      </endpoints>
      <context-variables>
        <response/>
        <datum/>
      </context-variables>
      <execute>
        <manipulate id="preparations">
          <variable context="datum" local="datum"/>
          <variable input-parameter="date" local="date"/>
          datum = "#{date.mday &lt; 10 ? "0#{date.mday}" : date.mday}.#{date.mon &lt; 10 ? "0#{date.mon}" : date.mon}.#{date.year}"
        </manipulate>
        <call id="Programm" endpoint="service" http-method="get">
          <input name="id" value="11"/>
          <input name="datum" variable="datum"/>
          <input name="uhrzeit" value="&quot;00:00:00&quot;"/>
          <input name="version" value="&quot;&quot;"/>
          <output variable="response" name="" type="complex"/>
        </call>
        <manipulate id="parse_programm">
          <variable context="response" local="response"/>
          <variable input-parameter="date" local="date"/> 
          <variable input-parameter="title" local="title"/> 
          <variable output-parameter="list" local="list"/>
          str = CGI::unescapeHTML(response)
          str.gsub!('&amp;','--amp--')
          offset = str.index("selected=\"selected\"", str.index("uclKinoprogramm$DDL_Datum"))
          offset = str.index("value=\"", offset)
          d = str[offset+7..offset+16]

          str = str[str.index("&lt;div id=\"uclKinoprogramm_P_Filme\"&gt;")..-1]
          count = 1
          offset = 0
          while (count != 0) do
            offset = str.index("div", offset+1)
            count = count+1 if str[offset-1].chr == "&lt;"
            count = count-1 if str[offset-1].chr == "/"
          end
          str = str[0..offset-3]
          resp = XML::Smart.string(str)
          list = XML::Smart.string("&lt;list_of_shows/&gt;")
          resp.find("//table[descendant::td/a[contains(text(),'#{title}')]]").each do |b| 
            show_title = b.find("child::tr/td[1]/a").first.text.strip
            show_date = Date.parse(d)
            if show_date == date
              b.find("child::tr/td[3]/div/table").each do |show|
                show_hall = show.find("child::tr/td[1]/h4/span").first.text.strip
                show.find("child::tr/td[2]/span/a[text()]").each do |s|
                  show = list.root.add("show")
                  show.add("cinema_uri", "http://localhost:9290/groups/CinemasReal/REST/AugeGottes")
                  show.add("show_id", s.attributes['href'].gsub('--amp--','&amp;'))
                  show.add("title", show_title)
                  show.add("date", show_date.to_s)
                  show.add("time", s.text)
                  show.add("hall", show_hall)
                end
              end
            end
          end
          list = list.root.dump
        </manipulate>
        <!-- manipulate id="generate_output">
          <variable output-parameter="list" local="list"/>
          <variable context="xml" local="xml"/>
          list = XML::Smart.string("&lt;list_of_shows/&gt;")
          xml.each do |e|
            res = XML::Smart.string(e)
            node = list.root.add("show")
            node.add("title", res.find("//filmname").first.text)
            node.add("hall", res.find("//hall").first.text)
            node.add("time", res.find("//time").first.text)
            node.add("date", res.find("//date").first.text)
            node.add("show_id", res.find("//id").first.text)
            node.add("cinema_uri", "http://localhost:9290/groups/CinemasReal/Soap/LugnerCityKino")
          end
          list = list.root.dump
        </manipulate -->
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
    </search>
    <book>
      <endpoints>
        <ep>http://www.pri.univie.ac.at/~ralph/Testservices/Cinema.php</ep>
      </endpoints>
      <context-variables>
      </context-variables>
      <execute>
        <call id="book" endpoint="ep" http-method="post">
          <input name="showID" message-parameter="show_id"/>
          <output message-parameter="reservation_id" name="resID"/>
        </call>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
    </book>
  </operations>
</service-description>
