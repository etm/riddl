<?xml version="1.0"?>

<domain-description  xmlns="http://rescue.org/ns/domain/0.2"
            xmlns:domain="http://rescue.org/ns/domain/0.2"
            xmlns:rng="http://relaxng.org/ns/structure/1.0">
  <properties>
<!-- {{{ -->
    <rng:element name="address">
      <domain:caption xml:lang="en">Address</domain:caption>
      <domain:caption xml:lang="de">Adresse</domain:caption>
      <rng:element name="street">
        <domain:caption xml:lang="en">Street</domain:caption>
        <domain:caption xml:lang="de">Stra√üe</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="zip">
        <domain:caption xml:lang="en">ZIP</domain:caption>
        <domain:caption xml:lang="de">PLZ</domain:caption>
        <rng:data type="positiveInteger"/>
      </rng:element>
      <rng:element name="city">
        <domain:caption xml:lang="en">City</domain:caption>
        <domain:caption xml:lang="de">Stadt</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="state">
        <domain:caption xml:lang="en">State</domain:caption>
        <domain:caption xml:lang="de">Land</domain:caption>
        <rng:data type="string"/>
      </rng:element>
    </rng:element>
    <rng:element name="vendor">
      <domain:caption xml:lang="en">Vendor</domain:caption>
      <domain:caption xml:lang="de">Anbieter</domain:caption>
      <rng:element name="name">
        <domain:caption xml:lang="en">Name</domain:caption>
        <domain:caption xml:lang="de">Name</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="phone">
        <domain:caption xml:lang="en">Phone</domain:caption>
        <domain:caption xml:lang="de">Telephon</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="url">
        <domain:caption xml:lang="en">URL</domain:caption>
        <domain:caption xml:lang="de">URL</domain:caption>
        <rng:data type="string"/>
      </rng:element>
      <rng:element name="mail">
        <domain:caption xml:lang="en">@mail</domain:caption>
        <domain:caption xml:lang="de">@mail</domain:caption>
        <rng:data type="string"/>
      </rng:element>
    </rng:element>
<!-- }}} -->
  </properties>
  <operations>
    <operation name="search" short="search for avaliable shows" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ -->   
      <execute>
        <call id="perform_search" endpoint="resource_path" service-operation="search">
<!-- {{{ -->   
          <input name="title" message-parameter="title">
<!-- {{{ -->     
            <rng:element name="title">
              <domain:caption xml:lang="en">Movietitle</domain:caption>
              <domain:caption xml:lang="de">Filmtitel</domain:caption>
              <rng:data type="string"/>
            </rng:element>
<!-- }}} --> 
          </input>
          <input name="date" message-parameter="date">
<!-- {{{ -->     
            <rng:element name="date">
              <domain:caption xml:lang="en">Date</domain:caption>
              <domain:caption xml:lang="de">Datum</domain:caption>
              <rng:data type="date"/>
            </rng:element>
<!-- }}} --> 
          </input>
          <output name="list" message-parameter="list_shows">
<!-- {{{ -->     
            <rng:element name="list_of_shows">
              <rng:zeroOrMore>
                <rng:element name="show">
                  <rng:element name="cinema_uri">
                    <rng:data type="string"/>
                  </rng:element>
                  <rng:element name="show_id">
                    <rng:data type="string"/>
                  </rng:element>
                  <rng:element name="title">
                    <rng:data type="string"/>
                  </rng:element>
                  <rng:element name="date">
                    <rng:data type="date"/>
                  </rng:element>
                  <rng:element name="time">
                    <rng:data type="time"/>
                  </rng:element>
                  <rng:element name="hall">
                    <rng:data type="string"/>
                  </rng:element>
                </rng:element>
              </rng:zeroOrMore>
            </rng:element>
<!-- }}} --> 
          </output>
<!-- }}} -->  
        </call>
      </execute>
<!-- }}} -->  
    </operation>
    <operation name="search_and_book" short="search for shows, select show and book tickets" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ --> 
      <context-variables>
        <show_id/>
        <list/>
        <res/>
        <list_merge/>
        <number_of_shows/>
      </context-variables>
      <endpoints>
        <selected_cinema/>
      </endpoints>
      <execute>
        <call id="call_find" endpoint="resource_path" service-operation="search">
<!-- {{{ --> 
          <input name="title" message-parameter="title">
<!-- {{{ --> 
            <rng:element name="title">
              <domain:caption xml:lang="en">Movietitle</domain:caption>
              <domain:caption xml:lang="de">Filmtitel</domain:caption>
              <rng:data type="string"/>
            </rng:element>
<!-- }}} -->  
          </input>
          <input name="date" message-parameter="date">
<!-- {{{ --> 
            <rng:element name="date">
              <domain:caption xml:lang="en">Date</domain:caption>
              <domain:caption xml:lang="de">Datum</domain:caption>
              <rng:data type="date"/>
            </rng:element>
<!-- }}} -->   
          </input>
          <output name="list" variable="list"/>
<!-- }}} -->  
        </call>
        <manipulate id="merge_result">
<!-- {{{ --> 
          <variable context="list" local="list"/>
          <variable context="list_merge" local="m_list"/>
          <variable context="number_of_shows" local="nos"/>
          <variable input-parameter="title" local="title"/>
          <variable input-parameter="date" local="date"/>
          <variable input-parameter="time" local="time">
            <rng:element name="time">
              <domain:caption xml:lang="en">Time</domain:caption>
              <domain:caption xml:lang="de">Zeit</domain:caption>
              <rng:data type="time"/>
            </rng:element>
          </variable>
          xml = XML::Smart.string("&lt;list_of_shows/&gt;")
          if list.class == Array
            list.each do |v|
              l = XML::Smart.string(v)
              xml.root.add(l.find("//show"))
            end
          elsif list.class == String
            l = XML::Smart.string(list)
            xml.root.add(l.find("//show"))
          else
            raise "Unexpected class of return-value - class: #{list.class}"
          end
          m_list = xml.root.dump
          nos = xml.root.children.length
<!-- }}} -->  
        </manipulate>
        <choose>
          <alternative>
            <condition test="number_of_shows" comparator="&gt;" value="0"/>
            <call id="perform_select" endpoint="selector_service" endpoint-type="outside" http-method="post">
              <!-- {{{ --> 
              <resource-id xpath="/cinema_uri" endpoint="selected_cinema" name="target">
                <xslt id="iPhone" xml:lang="de">
                </xslt>
                <xslt id="iPhone" xml:lang="en">
                </xslt>
              </resource-id>
              <input name="data" variable="list_merge"/>
              <output name="show_id" variable="show_id"/>
              <output name="movie_title" message-parameter="movie_title">
                <!-- {{{ --> 
                <rng:element name="movie_title">
                  <rng:data type="string"/>
                </rng:element>
                <!-- }}} -->  
              </output>
              <output name="date" message-parameter="selected_date">
              <!-- {{{ --> 
                <rng:element name="selected_date">
                  <rng:data type="date"/>
                </rng:element>
              <!-- }}} -->  
              </output>
              <output name="starting_time" message-parameter="starting_time">
              <!-- {{{ --> 
                <rng:element name="starting_time">
                  <rng:data type="time"/>
                </rng:element>
              <!-- }}} -->  
              </output>
              <output name="hall" message-parameter="hall">
              <!-- {{{ --> 
                <rng:element name="hall">
                  <rng:data type="positiveInteger"/>
                </rng:element>
              <!-- }}} -->  
              </output>
            <!-- }}} -->  
            </call>
            <call id="call_book" endpoint="selected_cinema" service-operation="book">
            <!-- {{{ -->   
              <input name="show_id" variable="show_id"/>
              <output name="reservation_id" message-parameter="reservation_id">
              <!-- {{{ -->      
                <rng:element name="reservation_id">
                  <rng:data type="string"/>
                </rng:element>
              <!-- }}} --> 
              </output>
            <!-- }}} --> 
            </call>
            <manipulate id="set_status_success">
              <variable output-parameter="status" local="status">
                <rng:element name="status">
                  <rng:data type="positiveInteger"/>
                </rng:element>
              </variable>
              status = 200
            </manipulate>
          </alternative>
          <otherwise>
            <manipulate id="set_status_failed">
              <variable output-parameter="status" local="status">
                <rng:element name="status">
                  <rng:data type="positiveInteger"/>
                </rng:element>
              </variable>
              status = 200
            </manipulate>
          </otherwise>
        </choose>
      </execute>
<!-- }}} --> 
    </operation>
    <operation name="book" short="book tickets for a given show and cinema" xmlns="http://rescue.org/ns/controlflow/0.2">
<!-- {{{ -->     
      <execute>
        <call id="perform_book" endpoint="resource_path" service-operation="book" state-controlflow="execute">
<!-- {{{ -->     
          <input name="show_id" variable="show_id">
<!-- {{{ -->     
            <rng:element name="show_id">
              <domain:caption xml:lang="en">ShowID</domain:caption>
              <domain:caption xml:lang="de">VorstellungsID</domain:caption>
              <rng:data type="string"/>
            </rng:element>
<!-- }}} --> 
          </input>
          <output name="reservation_id" message-parameter="reservation_id">
<!-- {{{ -->     
            <rng:element name="reservation_id">
              <rng:data type="string"/>
            </rng:element>
<!-- }}} --> 
          </output>
<!-- }}} -->       
        </call>
      </execute>
<!-- }}} -->       
    </operation>
  </operations>
</domain-description>

