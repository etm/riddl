<?xml version="1.0"?>

<service-description xmlns="http://rescue.org/ns/service/0.2">
  <properties xmlns="http://rescue.org/ns/properties/0.2">
    <adress>
      <street>Dr.-Karl-Dorrek-Stra√üe 30</street>
      <zip>3500</zip>
      <city>Krems</city>
      <state>Austria</state>
    </adress>
    <vendor>
      <name>Kino im Kesselhaus</name>
      <phone>+43-2732-908000</phone>
      <url>http://www.kinoimkesselhaus.at</url>
      <mail>office@kinoimkesselhaus.at</mail>
    </vendor>
  </properties>
  <operations xmlns="http://rescue.org/ns/controlflow/0.2">
    <search>
      <endpoints>
        <service>http://www.kinoimkesselhaus.at/programm/programm-kino</service>
      </endpoints>
      <context-variables>
        <response/>
      </context-variables>
      <execute>
        <call id="FilmInfo" endpoint="service" http-method="get">
          <output variable="response" name="" type="complex"/>
          <output message-parameter="status" type="status"/>
        </call>
        <manipulate id="pares_response">
          <variable context="response" local="response"/>
          <variable input-parameter="date" local="date"/> 
          <variable input-parameter="title" local="title"/> 
          <variable output-parameter="list" local="list"/>
          response = CGI::unescapeHTML(response)
          response.gsub!("&amp;mdash;","")
          response.gsub!("&amp;nbsp;","")
          resp = XML::Smart.string(CGI::unescapeHTML(response))
          list = XML::Smart.string("&lt;list_of_shows/&gt;")
          resp.find("//x:td[@class='inhalt']/x:div/x:a[text()]", {"x"=&gt;"http://www.w3.org/1999/xhtml"}).each do |b| 
            show_title = b.text
            show_time = b.parent.text
            show_date = b.parent.parent.parent.children[0].text.split(' ')[1]
            id ="n.a."
            id = b.parent.find("child::x:a[@title='Ticket online bestellen']", {"x"=&gt;"http://www.w3.org/1999/xhtml"}).first
            id = id.attributes['href'] if id
            if id != "n.a." and show_title.downcase.include?(title.downcase) and show_date == "#{date.mday() &lt; 10 ? "0#{date.mday()}": date.mday()}.#{date.mon() &lt; 10 ? "0#{date.mon()}": date.mon()}"
              show = list.root.add("show")
              show.add("cinema_uri", "http://localhost:9290/groups/CinemasReal/Static/Kesselhaus")
              show.add("show_id", id)
              show.add("title", show_title)
              show.add("date", "#{date.year()}-#{date.mon() &lt; 10 ? "0#{date.mon()}": date.mon()}-#{date.mday() &lt; 10 ? "0#{date.mday()}": date.mday()}")
              show.add("time", show_time)
              show.add("hall", "n.a.")
            end
          end
          list = list.root.dump
        </manipulate>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
    </search>
    <book>
      <endpoints>
        <ep>http://www.pri.univie.ac.at/~ralph/Testservices/Cinema.php</ep>
      </endpoints>
      <context-variables>
      </context-variables>
      <execute>
        <call id="book" endpoint="ep" http-method="post">
          <input name="showID" message-parameter="show_id"/>
          <output message-parameter="reservation_id" name="resID"/>
        </call>
      </execute>
      <compensate/>
      <undo/>
      <redo/>
      <suspend/>
      <abort/>
    </book>
  </operations>
</service-description>
