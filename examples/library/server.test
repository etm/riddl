#!/usr/bin/ruby
require '../../lib/ruby/client'
require 'socket'
require 'pp'

t = Thread.new do
  puts `rackup server.ru`
end

up = false
until up
  begin
    TCPSocket.new('localhost', 9292)
    up = true
  rescue => e
    sleep 0.1
  end  
end

begin
  library = Riddl::Client.new("http://localhost:9292/","description.xml")
  books = library.resource("/books")
  status, res = books.request 'get' => [
    Riddl::Header.new("Library",7),
    Riddl::Parameter::Simple.new("author","Mangler"),
    Riddl::Parameter::Simple.new("title","12 bottles of beer on the wall")
  ]

  # status,res = library.resource("/books/7").get

  puts status
  res.each do |r|
    puts r.value.read
  end  
ensure  
  `pkill rackup`
  t.join
end
