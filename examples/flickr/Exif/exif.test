#!/usr/bin/ruby
require '../../lib/ruby/client'
require 'socket'

t = Thread.new do
  puts `rackup exif.ru`
end  

up = false
until up
  begin
    TCPSocket.new('localhost', 9292)
    up = true
  rescue => e
    sleep 0.1
  end  
end

exif = Riddl::Client.new("http://localhost:9292/")

key = File.read('../Flickr/flickr.key').strip
secret = File.read('../Flickr/flickr.secret').strip
if File.exists?('../Flickr/flickr.token')
  token = File.read('../Flickr/flickr.token').strip
else  
  token = "simulated"
end
title     = "RIDDL Logo"
desc      = "The official RIDDL logo, the first thing created for this project."
tags      = "RIDDL, REST, Composition, Evolution"
is_public = "1"
sig       = Digest::MD5.hexdigest("#{secret}api_key#{key}auth_token#{token}description#{desc}is_public#{is_public}tags#{tags}title#{title}")

status, res = exif.post [
  Riddl::Parameter::Simple.new("api_key", key),
  Riddl::Parameter::Simple.new("auth_token", token),
  Riddl::Parameter::Complex.new("photo","image/png",File.open('riddl.png','r'),'riddl.png'),
  Riddl::Parameter::Simple.new("title", title),
  Riddl::Parameter::Simple.new("description", desc),
  Riddl::Parameter::Simple.new("tags", tags),
  Riddl::Parameter::Simple.new("is_public", is_public),
  Riddl::Parameter::Simple.new("api_sig", sig)
]

# status,res = library.resource("/books/7").get

puts status
p res
res.each do |r|
  puts r.value.read
end  

`pkill rackup`
t.join
