<description datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes" xmlns="http://riddl.org/ns/description/1.0" xmlns:xi="http://www.w3.org/2001/XInclude">

  <message name="topics">
    <parameter name="topics" mimetype="text/xml" handler="http://riddl.org/ns/handlers/relaxng">
      <grammar xmlns="http://relaxng.org/ns/structure/1.0" datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes" ns="http://riddl.org/ns/common-patterns/notification-producer/1.0">
        <start>
          <element name="topics">
            <zeroOrMore>
              <ref name="topic"/>
            </zeroOrMore>  
          </element>
        </start>

        <define name="topic">
          <element name="topic">
            <attribute name="id">
              <data type="string"/>
            </attribute>  
            <oneOrMore>
              <element name="event">
                <data type="string">
                  <param name="pattern">(\w*,)*(\w*)</param>
                </data>
              </element>  
            </oneOrMore>
          </element>
        </define>  

      </grammar>
    </parameter>
  </message>
  
  <message name="subscriptions">
    <parameter name="subscriptions" mimetype="text/xml" handler="http://riddl.org/ns/handlers/relaxng">
      <grammar xmlns="http://relaxng.org/ns/structure/1.0" datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes" ns="http://riddl.org/ns/common-patterns/notification-producer/1.0">
        <start>
          <element name="subscriptions">
            <attribute name="information">
              <choice>
                <value>full</value>
                <value>production</value>
              </choice>  
            </attribute>
            <zeroOrMore>
              <ref name="subscription"/>
            </zeroOrMore>  
          </element>
        </start>

        <define name="subscription">
          <element name="subscription">
            <attribute name="id">
              <data type="string"/>
            </attribute>
          </element>
        </define>

      </grammar>
    </parameter>
  </message>
  
  <message name="subscription">
    <parameter name="subscription" mimetype="text/xml" handler="http://riddl.org/ns/handlers/relaxng">
      <grammar xmlns="http://relaxng.org/ns/structure/1.0" datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes" ns="http://riddl.org/ns/common-patterns/notification-producer/1.0">
        <start>
          <element name="subscription">
            <attribute name="url">
              <data type="string"/>
            </attribute>
            <attribute name="request-secret">
              <choice>
                <value>valid</value>
                <value>invalid</value>
              </choice>
            </attribute>
            <attribute name="response-secret">
              <choice>
                <value>valid</value>
                <value>invalid</value>
              </choice>
            </attribute>
            <oneOrMore>
              <element name="topic">
                <data type="string"/>
              </element>
            </oneOrMore>
          </element>
        </start>
      </grammar>
    </parameter>
  </message>
  
  <message name="request">
    <parameter name="request-secret" type="string"/>
  </message>

  <message name="subscribe">
    <parameter name="url" type="string"/>
    <oneOrMore>
      <parameter name="event" type="string">
         <param name="pattern">(\w*,)*(\w*)</param>
      </parameter>
      <parameter name="topic" type="string"/>
    </oneOrMore>
    <parameter name="public-key" type="string"/>
  </message>  
  <message name="acknowledgment">
    <parameter name="key" type="string"/>
    <parameter name="request-secret" type="string"/>
    <parameter name="response-secret" type="string"/>
    <parameter name="change-secret" type="string"/>
  </message>

  <message name="details">
    <parameter name="url" type="string"/>
    <oneOrMore>
      <parameter name="event" type="string">
         <param name="pattern">(\w*,)*(\w*)</param>
      </parameter>
      <parameter name="topic" type="string"/>
    </oneOrMore>
    <parameter name="request-secret" type="string"/>
  </message>

  <message name="new-secrets">
    <parameter name="request-secret" type="string"/>
    <parameter name="response-secret" type="string"/>
    <parameter name="change-secret" type="string"/>
  </message>  
  <message name="change-secrets">
    <parameter name="change-secret" type="string"/>
  </message>

  <message name="overview">
    <parameter name="overview" mimetype="text/xml" handler="http://riddl.org/ns/handlers/relaxng">
      <grammar xmlns="http://relaxng.org/ns/structure/1.0" datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes" ns="http://riddl.org/ns/common-patterns/notification-producer/1.0">
        <start>
          <element name="info">
            <attribute name='instance'>
              <data type="integer"/>
            </attribute>
            <element name="secret">
              <empty/>
            </element>
            <element name="topics">
              <empty/>
            </element>
            <element name="subscriptions">
              <empty/>
            </element>
          </element>
        </start>
      </grammar>
    </parameter>
  </message>

  <resource pattern="http://riddl.org/ns/common-patterns/notification-producer/1.0">
    <resource relative="notifications">
      <get in="*" out="overview"/>
      <resource relative="secret">
        <post in="change-secrets" out="new-secrets"/>
      </resource>
      <resource relative="topics">
        <get in="*" out="topics"/>
      </resource>
      <resource relative="subscriptions">
        <get in="*" out="subscriptions"/>
        <post in="subscribe" out="acknowledgment"/>
        <resource>
          <get in="*" out="subscription"/>
          <put in="details"/>
          <delete in="request"/>
        </resource>
      </resource>
    </resource>
  </resource>  

</description>
